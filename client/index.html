<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-signin-client_id" content="350485092793-859l7a6sjbpk7aai44lqrardo7t25h7v.apps.googleusercontent.com">

    <title>Fancy Todo App</title>
</head>
<body>
    <nav>
        <button id="btn-logout">logout</button>
    </nav>
    <!-- Register -->
    <div id="register-form">
        <h1>Register Form</h1>
        <form action="" method="post">
            <label for="input-email" >Email</label>
            <input type="text"id="regist-email">
            <br><br>
            <label for="input-password">Password</label>
            <input type="password"id='regist-password'>
            <br><br>
            <input type="submit" value="Sign Up">
        </form>

    </div>
    <!-- Login -->
    <div id="login-form">
        <h1>Login Form</h1>
        <form id="login-form2" action="" method="post">
            <label for="input-email">Email</label>
            <input type="text"id="login-email">
            <br><br>
            <label  for="input-password">Password</label>
            <input type="password"id="login-password">
            <br>
            <br>
            <input type="submit" value="Login">

        </form>
        <br>
        <button  id="btn-register" >Register</button>
        <div class="g-signin2" data-onsuccess="onSignIn"></div>
    </div>
    <div id="main-page">
    <!-- main page -->
    <h1>Fancy To Do</h1>
    <br><br>
    <form action="" id="addNew-form">
        <label for="input-title">Title</label>
        <input  type="text" id="input-title">
        <br>
        <br>
        <label for="input-description">Description</label>
        <input type="text" id="input-description">
        <br>
        <br>
        <label for="input-status">Status</label>
        <input type="text" id="input-status">
        <br>
        <br>
        <label for="input-date">Due Date</label>
        <input  type="date" id="input-date">
        <br>
        <br>
        <input type="submit" value="Add New">
    </form>
    <br><br>
        <table border="2px" id="todo-table">
            <thead>
                <th>Title</th>
                <th>Description</th>
                <th>Status</th>
                <th>Due Date</th>
                <th>Action</th>
            </thead>
            <tbody id="todo-list">
            </tbody>
        </table>
    </div>
    <form action="" id="putTodo-form">
        <h1>Edit Todo</h1>
    </form>

    
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous">
    </script>
    <script>
    let baseUrl = 'http://localhost:3000'
    function registerSubmit(payload) {
        $.ajax({
            method : "POST",
            url : `${baseUrl}/register`,
            data :payload
        })
        .done(response =>{
            console.log('success')
            $("#register-form").trigger("reset")
            showLogin()


        })
        .fail((err, text) =>{
            console.log('>>>',err)
            console.log(text)
        })
    }
    function loginSubmit(payload) {
        $.ajax({
            method : "POST",
            url : `${baseUrl}/login`,
            data :payload
        })
        .done(response =>{
            console.log(response)
            $("#login-form2").trigger("reset")
            localStorage.setItem('token_access', response.token_access)
            mainPage()

        })
        .fail((err, text) =>{
            console.log('>>>',err)
            console.log(text)
        })
    }
    // function patchSubmit(payload, id){
    //     let token_access = localStorage.token_access
    //     $.ajax({
    //         method: "PATCH",
    //         url: `${baseUrl}/todos/${id}`,
    //         data: payload,
    //         headers: {token_access}
    //     })
    //     .done(response =>{
    //         console.log('sampai patchSubmit DONE', response)
    //         mainPage()
    //         $("#putTodo-form").empty()

    //     })
    //     .fail(err =>{
    //         console.log('sampai patchSubmit')
    //         console.log(err)
    //     })
    // }
    function putSubmit(payload, EditId){
        let token_access = localStorage.token_access
        $.ajax({
            method: "PUT",
            url: `${baseUrl}/todos/${EditId}`,
            data: payload,
            headers: {token_access}
        })
        .done(response =>{
            // console.log('sampai putSubmit DONE', response)
            mainPage()
            $("#putTodo-form").empty()

        })
        .fail(err =>{
            console.log(err)
        })
    }
    function putTodo(id){
        $("#register-form").hide()
        $("#login-form").hide()
        $("#main-page").hide()
        $("#putTodo-form").show()

        let token_access = localStorage.token_access
        $.ajax({
            method: "GET",
            url : `${baseUrl}/todos/${id}`,
            headers: {token_access}
        })
        .done(response =>{
            console.log(response)
            $("#putTodo-form").append(
                `<label for="input-putTitle">Title</label>
                <input type="text" id="input-putTitle" value="${response.title}">
                <br>
                <br>
                <label for="input-putDescription">Description</label>
                <input type="text" id="input-putDescription" value="${response.description}">
                <br>
                <br>
                <label for="input-putStatus">Status</label>
                <input type="text" id="input-putStatus" value="${response.status}">
                <br>
                <br>
                <label for="input-putDate">Due Date</label>
                <input type="date" id="input-putDate" value="${response.date.substr(0, 10)}">
                <br>
                <br>
                <input type="hidden" id="editId" value="${response.id}">
                <input type="submit" value="Edit">
            `)
        })
        .fail(err =>{
            console.log(err)
        })
    }
    function deleteTodo(id){
        let token_access = localStorage.token_access
        $.ajax({
            method: "DELETE",
            url : `${baseUrl}/todos/${id}`,
            headers: {token_access}
        })
        .done(response =>{
            fetchTodo()

        })
        .fail(err =>{
            console.log(err)
        })
    }
    function createNew(payload){
        let token_access = localStorage.token_access
        $.ajax({
            method : "POST",
            url : `${baseUrl}/todos`,
            data :payload,
            headers: {token_access}
        })
        .done(response =>{
            console.log(response)
            fetchTodo()
            $("#addNew-form").trigger("reset")

        })
        .fail((err, text) =>{
            console.log('>>>',err)
            console.log(text)
        })
    }
    function getStatus(id){
        $("#register-form").hide()
        $("#login-form").hide()
        $("#main-page").hide()
        $("#putTodo-form").show()

        let token_access = localStorage.token_access
        $.ajax({
            method: "GET",
            url : `${baseUrl}/todos/${id}`,
            headers: {token_access}
        })
        .done(response =>{
            // console.log(response)
            $("#putTodo-form").append(
                `<label for="input-putTitle">Title</label>
                <input type="text" id="input-putTitle" disabled value="${response.title}">
                <br>
                <br>
                <label for="input-putDescription">Description</label>
                <input type="text" id="input-putDescription" disabled value="${response.description}">
                <br>
                <br>
                <label for="input-putStatus">Status</label>
                <input type="text" id="input-putStatus" value="${response.status}">
                <br>
                <br>
                <label hidden for="input-putDate">Due Date</label>
                <input hidden type="date" id="input-putDate" value="${response.date.substr(0, 10)}">
                <br>
                <br>
                <input type="hidden" id="editId" value="${response.id}">
                <input type="submit" value="Edit">
            `)
        })
        .fail(err =>{
            console.log(err)
        })
    }
    
    function fetchTodo(){
        $('#quote').remove()

        let token_access = localStorage.token_access
        $.ajax({
            method: 'GET',
            url: `${baseUrl}/todos`,
            headers: {token_access}
        })
        .done(response =>{
            $("#todo-list").empty()
            $('#todo-table').after(`<br><br><div id="quote"><h4>${response.quote.quoteText}</h4><p>- ${response.quote.quoteAuthor} -</p> </div>`)
            response.listTodo.forEach(todo => {
                $("#todo-list").append(`<tr> 
                    <td>${todo.title}</td>
                    <td>${todo.description}</td>
                    <td>${todo.status}    <button onclick="getStatus(${todo.id})">update</button></td>
                    <td>${todo.date.substr(0, 10)}</td>   
                    <td><button  onclick="deleteTodo(${todo.id})">Delete</button><button onclick="putTodo(${todo.id})">Edit</button></td>
                    </tr> `)
            });
        })
        .fail(xhr =>{
            console.log(xhr)
        })
    }
    function showRegister () {
        $("#register-form").show()
        $("#login-form").hide()
        $("#main-page").hide()
        $("#putTodo-form").hide()
        $("#btn-logout").hide()


    }
    function showLogin() {
        $("#register-form").hide()
        $("#login-form").show()
        $("#main-page").hide()
        $("#putTodo-form").hide()
        $("#btn-logout").hide()
    }
    function mainPage(){
        $("#register-form").hide()
        $("#login-form").hide()
        $("#putTodo-form").hide()
        $("#main-page").show()
        $("#btn-logout").show()

        fetchTodo()
        console.log('MAIN PAGE')
    }
    function logout(){

        localStorage.clear();
        showLogin()
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.signOut().then(function () {
        console.log('User signed out.');
        });
    }
    function onSignIn(googleUser) {
        let googleToken = googleUser.getAuthResponse().id_token;
        $.ajax({
            url: `${baseUrl}/googleLogin`,
            method: 'POST',
            data: {
                googleToken
            }
        })
        .done(response =>{
            console.log('-->>>>',response)
            localStorage.setItem('token_access', response.token_access)
            mainPage()

        })
        .fail(err =>{
            console.log(err)
        })

    }

//========================= event trigerrer ======================================

    $(document).ready(() =>{
        if(localStorage.getItem('token_access')){
            mainPage()
            
        } else {
            showLogin()
            
            
        }
        $("#register-form").on("submit", function (e) {
            e.preventDefault()
            let email =  $("#regist-email").val()
            let password =  $("#regist-password").val()
            registerSubmit({email, password})
        })
        $("#login-form").on("submit", function (e) {
            e.preventDefault();
            let email =  $("#login-email").val()
            let password =  $("#login-password").val()

            loginSubmit({email, password})
        })
        $("#addNew-form").on("submit", function (e) {
            e.preventDefault();
            let newData = {           
                title : $("#input-title").val(),
                description : $("#input-description").val(),
                status : $("#input-status").val(),
                date :$("#input-date").val()
            }
        createNew(newData)
        })
        $("#putTodo-form").on('submit', function (e) {
            e.preventDefault();
            let editId =  $("#editId").val()
            let editedData ={
                title : $("#input-putTitle").val(),
                description : $("#input-putDescription").val(),
                status : $("#input-putStatus").val(),
                date :$("#input-putDate").val()
            }
            console.log(editId)
            putSubmit(editedData, editId)

        })
        $("#btn-logout").on("click", (e) =>{
            logout()
        })
        $("#btn-register").on("click", (e) =>{
            $("#btn-register").hide()
            showRegister()
        })

       

    })
    
    </script>
</body>
</html>